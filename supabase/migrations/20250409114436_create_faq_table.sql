CREATE TABLE faq (
  id SERIAL PRIMARY KEY,
  category TEXT NOT NULL,
  question TEXT NOT NULL,
  answer TEXT NOT NULL,
  order_num INTEGER NOT NULL DEFAULT 0,
  is_published BOOLEAN NOT NULL DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ
);

-- Индекс для поиска
CREATE INDEX faq_category_idx ON faq(category);
CREATE INDEX faq_question_text_idx ON faq USING gin(to_tsvector('russian', question));

-- RLS политики
ALTER TABLE faq ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Public read access to published FAQ"
  ON faq FOR SELECT
  USING (is_published = true);

-- Функция для автоматического обновления updated_at
CREATE OR REPLACE FUNCTION trigger_set_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Триггер для обновления updated_at
CREATE TRIGGER set_faq_updated_at
BEFORE UPDATE ON faq
FOR EACH ROW
EXECUTE FUNCTION trigger_set_updated_at();

-- Добавление тестовых данных
INSERT INTO faq (category, question, answer, order_num) VALUES
('Доступ к уровням', 'Как получить доступ к следующему уровню?', 'Для получения доступа к следующему уровню необходимо завершить текущий уровень, посмотрев все видео и пройдя тесты с результатом не менее 70%. После этого следующий уровень разблокируется автоматически.', 1),
('Доступ к уровням', 'Могу ли я пропустить уровень?', 'Нет, система построена для последовательного прохождения уровней. Каждый следующий уровень доступен только после полного завершения предыдущего.', 2),
('Видеоматериалы', 'Могу ли я скачать видео для просмотра офлайн?', 'Нет, видеоматериалы доступны только для онлайн-просмотра через платформу. Однако вы можете скачать сопутствующие артефакты, такие как конспекты и дополнительные материалы.', 1),
('Видеоматериалы', 'Что делать если видео не загружается?', 'Если видео не загружается, проверьте ваше интернет-соединение. Если проблема сохраняется, попробуйте очистить кэш браузера или использовать другой браузер. Если эти меры не помогают, обратитесь в службу поддержки.', 2),
('Тестирование', 'Что делать, если я не могу пройти тест?', 'Если вы не можете пройти тест, мы рекомендуем пересмотреть видеоматериалы уровня и изучить артефакты. Тесты можно пересдавать неограниченное количество раз. Если у вас остаются вопросы, обратитесь в чат поддержки.', 1),
('Тестирование', 'Как часто обновляются тестовые вопросы?', 'Тестовые вопросы обновляются при значительных изменениях в содержании курса. Обычно это происходит раз в квартал, но может быть чаще для отдельных уровней.', 2),
('Оплата', 'Какие способы оплаты вы принимаете?', 'Мы принимаем кредитные и дебетовые карты (Visa, MasterCard), а также платежи через электронные системы PayPal и WebMoney. В скором времени будет доступна оплата через криптовалюту.', 1),
('Оплата', 'Можно ли получить возврат средств?', 'Да, возврат средств возможен в течение 14 дней с момента оплаты, если вы не использовали платформу (не просмотрели более 25% доступного контента). Для запроса возврата обратитесь в службу поддержки.', 2),
('Техническая поддержка', 'Как связаться с технической поддержкой?', 'Вы можете связаться с технической поддержкой через форму обратной связи в разделе "Чат поддержки" или по электронной почте support@bizlevel.com. Время ответа составляет до 24 часов в рабочие дни.', 1),
('Техническая поддержка', 'В какое время работает поддержка?', 'Техническая поддержка работает с понедельника по пятницу с 9:00 до 18:00 по московскому времени. В выходные и праздничные дни ответ может занять больше времени.', 2);
