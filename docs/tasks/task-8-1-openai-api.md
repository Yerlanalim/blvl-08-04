# Задача 8.1: Настройка взаимодействия с OpenAI API

## Подготовка

Перед началом выполнения задачи, пожалуйста, ознакомьтесь с следующими документами для восстановления контекста:
- [Концепция проекта](../docs/bizlevel-concept.md)
- [План разработки](../docs/development-plan.md)
- [Текущий статус проекта](../docs/status.md)

## Описание задачи

Необходимо настроить взаимодействие приложения BizLevel с OpenAI API для реализации функционала ИИ-ассистента. Эта интеграция позволит пользователям задавать вопросы и получать подробные ответы от ИИ в контексте образовательного материала.

### Шаги выполнения:

1. **Создание API-маршрута для обращения к OpenAI API:**
   - Разработать маршрут `/api/ai/chat` для обработки запросов к OpenAI
   - Реализовать обработку POST-запросов с сообщениями пользователей
   - Настроить проверку авторизации и валидацию запросов
   - Добавить обработку ошибок и ограничение количества запросов

2. **Настройка безопасного хранения API-ключа:**
   - Добавить переменную окружения для API-ключа OpenAI
   - Настроить защищенный доступ к ключу только из серверного кода
   - Обновить документацию по настройке переменных окружения
   - Создать тестовый ключ для разработки (с ограничениями)

3. **Реализация базовой логики обработки запросов и ответов:**
   - Разработать сервис для формирования запросов к OpenAI API
   - Реализовать обработку ответов и преобразование их в нужный формат
   - Добавить механизмы обработки ошибок и повторных попыток
   - Реализовать кеширование частых запросов для оптимизации

4. **Создание системного промпта для контекста:**
   - Разработать системный промпт, описывающий роль ИИ-ассистента
   - Настроить контекст с учетом образовательных материалов BizLevel
   - Добавить ограничения и инструкции по формату ответов
   - Реализовать возможность расширения контекста с данными о пользователе

## Структура API-маршрута

```typescript
// Пример структуры API-маршрута для OpenAI API
export async function POST(req: Request) {
  try {
    // Валидация запроса и проверка авторизации
    const { messages } = await req.json();
    
    // Формирование запроса к OpenAI API
    const response = await openai.chat.completions.create({
      model: "gpt-4",
      messages: [
        { role: "system", content: SYSTEM_PROMPT },
        ...messages
      ],
      temperature: 0.7,
    });
    
    // Обработка и возвращение ответа
    return new Response(JSON.stringify(response.choices[0].message), {
      headers: { 'Content-Type': 'application/json' },
    });
  } catch (error) {
    // Обработка ошибок
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' },
    });
  }
}
```

## Системный промпт

Базовая структура системного промпта:
```
Ты ИИ-ассистент образовательной платформы BizLevel. Твоя задача - помогать пользователям с вопросами по образовательному материалу.

Правила:
1. Давай точные и конкретные ответы на вопросы пользователей
2. Если тебе недостаточно информации, попроси уточнить вопрос
3. Ограничивай свои ответы тематикой образовательных материалов
4. Формат ответов должен быть лаконичным и структурированным
5. Используй Markdown для форматирования ответов

Информация о платформе BizLevel:
[здесь будет информация о платформе и курсах]
```

## Проверка работы

Для проверки корректности интеграции с OpenAI API выполните:
- Тестирование API-маршрута с различными запросами
- Проверка обработки ошибок при неверных запросах
- Тестирование системного промпта и качества ответов
- Проверка безопасности хранения API-ключа
- Тестирование ограничений и повторных попыток при ошибках

## Ожидаемый результат

- Функциональный API-маршрут для обращения к OpenAI API
- Безопасное хранение и использование API-ключа
- Базовая логика обработки запросов и ответов
- Настроенный системный промпт с контекстом образовательной платформы

## Дополнительные материалы

- [Документация OpenAI API](https://platform.openai.com/docs/api-reference)
- [Next.js API Routes](https://nextjs.org/docs/api-routes/introduction)
- [Безопасное хранение секретов](https://vercel.com/docs/environment-variables)
- [Prompt Engineering](https://platform.openai.com/docs/guides/prompt-engineering)
- [Rate Limiting в Next.js](https://github.com/upstash/ratelimit)

## После выполнения

После завершения задачи не забудьте обновить файл [status.md](../docs/status.md) с информацией о реализованной интеграции с OpenAI API, настройке системного промпта и любых возникших проблемах при разработке функционала. 