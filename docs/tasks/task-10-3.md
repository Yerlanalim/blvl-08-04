# Задача 10.3: Обработка webhook'ов и разблокировка платного контента

## Подготовка
Перед началом работы ознакомьтесь с документами, чтобы восстановить контекст проекта:
- [Статус проекта](../docs/status.md)
- [План разработки](../docs/development-plan.md)
- [Концепция проекта](../docs/bizlevel-concept.md)

## Описание задачи
Необходимо реализовать обработку webhook'ов от Stripe для автоматической разблокировки платного контента после успешной оплаты. Это критически важный компонент системы платежей, который обеспечивает надежное получение уведомлений о статусе платежей и соответствующее обновление доступов пользователей.

### Основные требования:
1. Создание эндпоинта для приема webhook'ов от Stripe:
   - Реализовать API-маршрут в Next.js для приема webhook-уведомлений от Stripe
   - Настроить корректную обработку различных типов событий (payment_intent.succeeded, checkout.session.completed и др.)
   - Обеспечить асинхронную обработку webhooks для быстрого ответа Stripe

2. Реализация проверки подписи webhook'а:
   - Внедрить механизм проверки подписи webhook'а для предотвращения подделки запросов
   - Настроить хранение секретного ключа webhook'а в переменных окружения
   - Добавить обработку ошибок валидации подписи

3. Добавление логики разблокировки платных уровней:
   - Создать функцию для обновления прав доступа пользователя к оплаченным уровням
   - Настроить связь между ID продукта в Stripe и ID уровня в базе данных
   - Реализовать логику определения, какие именно уровни должны быть разблокированы

4. Обновление прогресса пользователя после оплаты:
   - Обновить записи в таблице user_progress для отражения новых доступов
   - Обеспечить корректное отображение разблокированных уровней на карте уровней
   - Добавить уведомление пользователю о разблокировке новых уровней при следующем входе

## Технические детали
- Используйте webhook-функционал библиотеки stripe-js для обработки webhook'ов
- Для работы с Supabase важно проверить, что связь двухсторонняя и стабильная, особенно при обновлении прогресса пользователей
- Webhook эндпоинт должен быть доступен публично (в production через HTTPS)
- В тестовом режиме используйте Stripe CLI для локального тестирования webhook'ов
- Обязательно обработайте случаи повторных webhook'ов (идемпотентность)

## Проверки и тестирование
- Настройте и протестируйте webhook'и с использованием Stripe CLI
- Проверьте обработку различных типов событий от Stripe
- Убедитесь, что после успешной оплаты уровень корректно разблокируется
- Проверьте корректную обработку ошибок и краевых случаев (повторные webhook'и, неверная подпись и т.д.)
- Добавьте логирование для облегчения отладки webhook-событий

## Завершение задачи
После выполнения задачи:
1. Обновите файл [status.md](../docs/status.md) с описанием выполненной работы и решенных проблем
2. Убедитесь, что все изменения корректно сохранены и код следует общему стилю проекта
3. Проверьте, что webhook-эндпоинт работает стабильно и безопасно 